#!/usr/bin/env python3
"""
æµ‹è¯• Story Mode çš„ prompt ç”Ÿæˆå’Œ Stable Audio è°ƒç”¨
"""

import os
import sys
import traceback

# è®¾ç½®ç¯å¢ƒå˜é‡
os.environ['HF_TOKEN'] = 'your-huggingface-token-here'  # æ›¿æ¢ä¸ºä½ çš„token
os.environ['GEMINI_API_KEY'] = 'AIzaSyAqeUjWY_u59F_Tbxm3FfE9JTJqoGMdZAI'

def test_story_prompt():
    """æµ‹è¯•Story Modeçš„promptç”Ÿæˆ"""
    print("ğŸ”§ æµ‹è¯• Story Mode çš„ prompt ç”Ÿæˆ")
    print("=" * 50)
    
    try:
        # å¯¼å…¥æœåŠ¡
        from app.services.ai_service import AIService
        from app.services.stable_audio_service import stable_audio_service
        
        # åˆå§‹åŒ–AIæœåŠ¡
        ai_service = AIService()
        
        # æµ‹è¯•æ•…äº‹æè¿°
        original_description = "A young wizard discovers an ancient library hidden in the depths of a mystical forest. The air is thick with the scent of old books and the gentle whisper of forgotten spells."
        print(f"åŸå§‹æ•…äº‹æè¿°: {original_description}")
        
        # ç”Ÿæˆç®€åŒ–çš„ soundscape prompt
        soundscape_prompt = f"""
Based on the story description, create a simple audio prompt for background soundscape generation. Focus on 2-3 core sound elements that would complement the narrative. Keep it concise and specific.

Story: {original_description}

Generate a simple audio prompt with 2-3 sound elements. Use ONLY concrete, specific sound types that Stable Audio can generate well:
- Environmental sounds: Rain, Wind, Ocean waves, Forest sounds, Bird songs, Thunder
- Urban sounds: Traffic, Car horns, Cafe ambience, Coffee machine, Footsteps
- Nature sounds: Water dripping, Fire crackling, Leaves rustling, Stream flowing
- Mechanical sounds: Clock ticking, Fan humming, Air conditioning, Engine running

Examples of good prompts: "Forest sounds with bird songs", "Rain with distant thunder", "Cafe ambience with coffee machine", "Ocean waves with seagull calls"

Avoid abstract or poetic descriptions. Focus on specific, concrete sounds that can be generated by audio models.
"""
        
        print(f"å‘é€ç»™AIçš„prompt: {soundscape_prompt}")
        
        # è°ƒç”¨AIç”Ÿæˆprompt
        response = ai_service.client.models.generate_content(
            model=ai_service._get_current_model(),
            contents=soundscape_prompt
        )
        
        stable_audio_prompt = response.text.strip() if response and response.text else "Forest ambience with bird songs"
        # æ¸…ç†promptï¼Œåªå–ç¬¬ä¸€è¡Œ
        stable_audio_prompt = stable_audio_prompt.split('\n')[0].strip()
        
        # å¦‚æœç”Ÿæˆçš„promptåŒ…å«æŠ½è±¡è¯æ±‡ï¼Œä½¿ç”¨fallback
        abstract_words = ['whispering', 'faint', 'celestial', 'hint', 'suggestion', 'gentle', 'soft', 'subtle']
        if any(word in stable_audio_prompt.lower() for word in abstract_words):
            print(f"ç”Ÿæˆçš„promptåŒ…å«æŠ½è±¡è¯æ±‡ï¼Œä½¿ç”¨fallback")
            stable_audio_prompt = "Forest sounds with bird songs"
        
        print(f"ç”Ÿæˆçš„Stable Audio prompt: '{stable_audio_prompt}'")
        
        # æµ‹è¯•Stable Audioç”Ÿæˆ
        print(f"\nå¼€å§‹æµ‹è¯•Stable Audioç”Ÿæˆ...")
        audio_path = stable_audio_service.generate_audio(stable_audio_prompt, duration=10.0)
        
        print(f"âœ… éŸ³é¢‘ç”ŸæˆæˆåŠŸ: {audio_path}")
        
        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if os.path.exists(audio_path):
            file_size = os.path.getsize(audio_path)
            print(f"æ–‡ä»¶å¤§å°: {file_size} bytes")
        else:
            print("âŒ æ–‡ä»¶ä¸å­˜åœ¨")
            
    except Exception as e:
        print(f"âŒ é”™è¯¯: {e}")
        print("è¯¦ç»†é”™è¯¯ä¿¡æ¯:")
        traceback.print_exc()

if __name__ == "__main__":
    test_story_prompt() 